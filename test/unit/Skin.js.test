const chromelessTest = require('../fixtures/chromeless-tape');

chromelessTest('Skin tests: 8 asserts: 6', async function (t, chromeless) {
    t.plan(6);
    try {
        const results = await chromeless.evaluate(async function (coverage) {
            try {
                window.__coverage__ = coverage;
                const context = {};
                return [
                    ['comment', 'loadModuleVarTest(...["Skin","./Skin.js"])'],
                    ...(await (function loadModuleVarTest (context, name, srcPath) {
                        context.module = context.module || {};
                        context.module[name] = window['scratch-render'](srcPath);
                        return [['ok', context.module[name]]];
                    })(context, ...["Skin","./Skin.js"]) || []),
                    ['comment', 'skinIdTest(...[])'],
                    ...(await (function skinIdTest (context) {
                        context.skinId = Math.random().toString().slice(2);
                    })(context, ...[]) || []),
                    ['comment', 'newSkinTest(...[])'],
                    ...(await (function newSkinTest (context) {
                        context.value = context.skin = new context.module.Skin(context.skinId);
                    })(context, ...[]) || []),
                    ['comment', 'getTest(...["on"])'],
                    ...(await (function getTest (context, key) {
                        return [['ok', key in context.value]];
                    })(context, ...["on"]) || []),
                    ['comment', 'getTest(...["off"])'],
                    ...(await (function getTest (context, key) {
                        return [['ok', key in context.value]];
                    })(context, ...["off"]) || []),
                    ['comment', 'getTest(...["id"])'],
                    ...(await (function getTest (context, key) {
                        return [['ok', key in context.value]];
                    })(context, ...["id"]) || []),
                    ['comment', 'getTest(...["rotationCenter"])'],
                    ...(await (function getTest (context, key) {
                        return [['ok', key in context.value]];
                    })(context, ...["rotationCenter"]) || []),
                    ['comment', 'rotationCenterIsArray(...[])'],
                    ...(await (function rotationCenterIsArray (context) {
                        return [['ok', context.value.rotationCenter.length >= 2]];
                    })(context, ...[]) || [])
                ].concat([['coverage', window.__coverage__]]);
            } catch (e) {
                return [['fail', e.stack || e.message]];
            }
        }, global.__coverage__);
        (results || []).map(([fn, ...args]) => {
            if (fn === 'coverage') global.__coverage__ = args[0];
            else if (t[fn]) t[fn](...args);
        });
    } catch (e) {
        t.fail(e.stack || e.message || e);
    }
});